#!/usr/bin/env php
<?php

/**
 * Benchpress report generator.
 *
 * Runs PHPBench, captures the XML dump, and produces a side-by-side
 * comparison matrix with subjects as columns and tests as rows.
 *
 * Usage:
 *   php bin/report [--format=cli|md|csv|json] [-- phpbench args...]
 *
 * Examples:
 *   php bin/report                          # CLI table
 *   php bin/report --format=md              # Markdown table
 *   php bin/report --format=json            # JSON output
 *   php bin/report -- --group=select        # Pass args to PHPBench
 */

declare(strict_types=1);

require_once dirname(__DIR__) . '/vendor/autoload.php';

/**
 * Parse arguments.
 */

$format = 'cli';
$phpbenchArgs = [];
$pastSeparator = false;

foreach (array_slice($argv, 1) as $arg) {
    if ($arg === '--') {
        $pastSeparator = true;
        continue;
    }

    if (!$pastSeparator && str_starts_with($arg, '--format=')) {
        $format = substr($arg, 9);
        continue;
    }

    if ($pastSeparator) {
        $phpbenchArgs[] = $arg;
    }
}

if (!in_array($format, ['cli', 'md', 'csv', 'json'], true)) {
    fwrite(STDERR, "Unknown format: {$format}. Use: cli, md, csv, json\n");
    exit(1);
}

/**
 * Run PHPBench with XML dump.
 */

$dumpFile = tempnam(sys_get_temp_dir(), 'benchpress_') . '.xml';
$phpbenchBin = dirname(__DIR__) . '/vendor/bin/phpbench';

$cmd = sprintf(
    '%s run --dump-file=%s --progress=dots %s 2>&1',
    escapeshellarg($phpbenchBin),
    escapeshellarg($dumpFile),
    implode(' ', array_map('escapeshellarg', $phpbenchArgs)),
);

fwrite(STDERR, "Running benchmarks...\n");
passthru($cmd, $exitCode);
fwrite(STDERR, "\n");

if ($exitCode !== 0 || !file_exists($dumpFile)) {
    fwrite(STDERR, "PHPBench failed (exit code {$exitCode}).\n");
    @unlink($dumpFile);
    exit(1);
}

/**
 * Parse XML output.
 */

$xml = simplexml_load_file($dumpFile);
@unlink($dumpFile);

if ($xml === false) {
    fwrite(STDERR, "Failed to parse XML output.\n");
    exit(1);
}

$config = file_exists(dirname(__DIR__) . '/config.php')
    ? require dirname(__DIR__) . '/config.php'
    : ['subjects' => []];

/**
 * Build a lookup: class short name → subject display name.
 */
$subjectNames = [];
foreach ($config['subjects'] as $key => $subject) {
    $subjectNames[$key] = $subject['name'] ?? $key;
}

/**
 * Extract results.
 *
 * Structure: $results[methodName][subjectLabel] = stats
 */
$results = [];
$subjects = [];

foreach ($xml->suite->benchmark ?? [] as $benchmark) {
    $class = (string) $benchmark['class'];

    /**
     * Extract subject key from class name.
     *
     * e.g. "Benchpress\Bench\StableSelectBench" → "Stable"
     * We match against config keys by checking if the class contains the key.
     */
    $classShort = basename(str_replace('\\', '/', $class));
    $subjectLabel = $classShort;

    foreach ($subjectNames as $key => $name) {
        if (stripos($classShort, ucfirst($key)) !== false || stripos($classShort, $key) !== false) {
            $subjectLabel = $name;
            break;
        }
    }

    if (!in_array($subjectLabel, $subjects, true)) {
        $subjects[] = $subjectLabel;
    }

    foreach ($benchmark->subject ?? [] as $subject) {
        $method = (string) $subject['name'];

        foreach ($subject->variant ?? [] as $variant) {
            $stats = $variant->stats;
            if ($stats === null) {
                continue;
            }

            $results[$method][$subjectLabel] = [
                'mean'   => (float) $stats['mean'],
                'mode'   => (float) ($stats['mode'] ?? $stats['mean']),
                'min'    => (float) $stats['min'],
                'max'    => (float) $stats['max'],
                'stdev'  => (float) $stats['stdev'],
                'rstdev' => (float) ($stats['rstdev'] ?? 0),
            ];
        }
    }
}

if (empty($results)) {
    fwrite(STDERR, "No benchmark results found.\n");
    exit(0);
}

ksort($results);

/**
 * Output in the requested format.
 */

match ($format) {
    'cli'  => outputCli($results, $subjects),
    'md'   => outputMarkdown($results, $subjects),
    'csv'  => outputCsv($results, $subjects),
    'json' => outputJson($results, $subjects),
};

/**
 * Format nanoseconds into a human-readable time string.
 */
function formatTime(float $nanoseconds): string
{
    if ($nanoseconds >= 1_000_000) {
        return sprintf('%.2fms', $nanoseconds / 1_000_000);
    }
    if ($nanoseconds >= 1_000) {
        return sprintf('%.2fμs', $nanoseconds / 1_000);
    }
    return sprintf('%.0fns', $nanoseconds);
}

/**
 * Output results as a CLI table.
 */
function outputCli(array $results, array $subjects): void
{
    $testWidth = max(4, ...array_map('strlen', array_keys($results)));
    $colWidth = max(10, ...array_map('strlen', $subjects));

    $header = str_pad('Test', $testWidth);
    foreach ($subjects as $s) {
        $header .= '  ' . str_pad($s, $colWidth);
    }
    echo $header . "\n";
    echo str_repeat('─', strlen($header)) . "\n";

    foreach ($results as $method => $data) {
        $times = array_map(fn($d) => $d['mean'], $data);
        $fastest = min($times);

        $row = str_pad($method, $testWidth);
        foreach ($subjects as $s) {
            if (isset($data[$s])) {
                $time = formatTime($data[$s]['mean']);
                $ratio = $data[$s]['mean'] / $fastest;
                $suffix = $ratio > 1.05 ? sprintf(' (%.1fx)', $ratio) : '';
                $cell = $time . $suffix;
            } else {
                $cell = '-';
            }
            $row .= '  ' . str_pad($cell, $colWidth);
        }
        echo $row . "\n";
    }
}

/**
 * Output results as a Markdown table.
 */
function outputMarkdown(array $results, array $subjects): void
{
    echo '| Test |';
    foreach ($subjects as $s) {
        echo " {$s} |";
    }
    echo "\n|------|";
    foreach ($subjects as $s) {
        echo str_repeat('-', strlen($s) + 2) . '|';
    }
    echo "\n";

    foreach ($results as $method => $data) {
        $times = array_map(fn($d) => $d['mean'], $data);
        $fastest = min($times);

        echo "| {$method} |";
        foreach ($subjects as $s) {
            if (isset($data[$s])) {
                $time = formatTime($data[$s]['mean']);
                $ratio = $data[$s]['mean'] / $fastest;
                $suffix = $ratio > 1.05 ? sprintf(' (%.1fx)', $ratio) : '';
                echo " {$time}{$suffix} |";
            } else {
                echo ' - |';
            }
        }
        echo "\n";
    }
}

/**
 * Output results as CSV.
 */
function outputCsv(array $results, array $subjects): void
{
    $out = fopen('php://stdout', 'w');

    fputcsv($out, array_merge(['test'], $subjects));

    foreach ($results as $method => $data) {
        $row = [$method];
        foreach ($subjects as $s) {
            $row[] = isset($data[$s]) ? round($data[$s]['mean'], 2) : '';
        }
        fputcsv($out, $row);
    }

    fclose($out);
}

/**
 * Output results as JSON.
 */
function outputJson(array $results, array $subjects): void
{
    $output = [
        'subjects' => $subjects,
        'results'  => [],
    ];

    foreach ($results as $method => $data) {
        $entry = ['test' => $method];
        foreach ($subjects as $s) {
            if (isset($data[$s])) {
                $entry[$s] = $data[$s];
            }
        }
        $output['results'][] = $entry;
    }

    echo json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) . "\n";
}
