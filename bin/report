#!/usr/bin/env php
<?php

/**
 * Benchpress report generator.
 *
 * Runs PHPBench, captures the XML dump, and produces a side-by-side
 * comparison matrix with subjects as columns and tests as rows.
 *
 * Usage:
 *   php bin/report [--format=cli|md|csv|json] [-- phpbench args...]
 *
 * Examples:
 *   php bin/report                          # CLI table
 *   php bin/report --format=md              # Markdown table
 *   php bin/report --format=json            # JSON output
 *   php bin/report -- --group=select        # Pass args to PHPBench
 */

declare(strict_types=1);

require_once dirname(__DIR__) . '/vendor/autoload.php';

use Benchpress\Report\ResultRenderer;
use Benchpress\Report\TimeFormatter;

/**
 * Parse arguments.
 */

$format = 'cli';
$phpbenchArgs = [];
$pastSeparator = false;

foreach (array_slice($argv, 1) as $arg) {
    if ($arg === '--') {
        $pastSeparator = true;
        continue;
    }

    if (!$pastSeparator && str_starts_with($arg, '--format=')) {
        $format = substr($arg, 9);
        continue;
    }

    if ($pastSeparator) {
        $phpbenchArgs[] = $arg;
    }
}

if (!in_array($format, ['cli', 'md', 'csv', 'json'], true)) {
    fwrite(STDERR, "Unknown format: {$format}. Use: cli, md, csv, json\n");
    exit(1);
}

/**
 * Run PHPBench with XML dump.
 */

$dumpFile = tempnam(sys_get_temp_dir(), 'benchpress_') . '.xml';
$phpbenchBin = dirname(__DIR__) . '/vendor/bin/phpbench';

$cmd = sprintf(
    '%s run --dump-file=%s --progress=dots %s 2>&1',
    escapeshellarg($phpbenchBin),
    escapeshellarg($dumpFile),
    implode(' ', array_map('escapeshellarg', $phpbenchArgs)),
);

fwrite(STDERR, "Running benchmarks...\n");
passthru($cmd, $exitCode);
fwrite(STDERR, "\n");

if ($exitCode !== 0 || !file_exists($dumpFile)) {
    fwrite(STDERR, "PHPBench failed (exit code {$exitCode}).\n");
    @unlink($dumpFile);
    exit(1);
}

/**
 * Parse XML output.
 */

$xml = simplexml_load_file($dumpFile);
@unlink($dumpFile);

if ($xml === false) {
    fwrite(STDERR, "Failed to parse XML output.\n");
    exit(1);
}

$config = file_exists(dirname(__DIR__) . '/config.php')
    ? require dirname(__DIR__) . '/config.php'
    : ['subjects' => []];

/**
 * Build a lookup: class short name → subject display name.
 */
$subjectNames = [];
foreach ($config['subjects'] as $key => $subject) {
    $subjectNames[$key] = $subject['name'] ?? $key;
}

/**
 * Extract results.
 *
 * Structure: $results[methodName][subjectLabel] = stats
 *            $memoryResults[methodName][subjectLabel] = peakBytes
 */
$results = [];
$memoryResults = [];
$subjects = [];

foreach ($xml->suite->benchmark ?? [] as $benchmark) {
    $class = (string) $benchmark['class'];

    /**
     * Extract subject key from class name.
     *
     * e.g. "Benchpress\Bench\StableSelectBench" → "Stable"
     * We match against config keys by checking if the class contains the key.
     */
    $classShort = basename(str_replace('\\', '/', $class));
    $subjectLabel = $classShort;

    foreach ($subjectNames as $key => $name) {
        if (stripos($classShort, ucfirst($key)) !== false || stripos($classShort, $key) !== false) {
            $subjectLabel = $name;
            break;
        }
    }

    if (!in_array($subjectLabel, $subjects, true)) {
        $subjects[] = $subjectLabel;
    }

    foreach ($benchmark->subject ?? [] as $subject) {
        $method = (string) $subject['name'];

        foreach ($subject->variant ?? [] as $variant) {
            $stats = $variant->stats;
            if ($stats === null) {
                continue;
            }

            $results[$method][$subjectLabel] = [
                'mean'   => (float) $stats['mean'],
                'mode'   => (float) ($stats['mode'] ?? $stats['mean']),
                'min'    => (float) $stats['min'],
                'max'    => (float) $stats['max'],
                'stdev'  => (float) $stats['stdev'],
                'rstdev' => (float) ($stats['rstdev'] ?? 0),
            ];

            /** Extract peak memory from iteration elements. */
            $peakMemory = 0.0;
            foreach ($variant->iteration ?? [] as $iteration) {
                $memPeak = (float) ($iteration['mem-peak'] ?? 0);
                if ($memPeak > $peakMemory) {
                    $peakMemory = $memPeak;
                }
            }
            if ($peakMemory > 0) {
                $memoryResults[$method][$subjectLabel] = $peakMemory;
            }
        }
    }
}

if (empty($results)) {
    fwrite(STDERR, "No benchmark results found.\n");
    exit(0);
}

ksort($results);
ksort($memoryResults);

/**
 * Output in the requested format.
 */

$renderer = new ResultRenderer();

echo match ($format) {
    'cli'  => $renderer->renderCli($results, $subjects, $memoryResults),
    'md'   => $renderer->renderMarkdown($results, $subjects, $memoryResults),
    'csv'  => $renderer->renderCsv($results, $subjects, $memoryResults),
    'json' => $renderer->renderJson($results, $subjects, $memoryResults),
};
